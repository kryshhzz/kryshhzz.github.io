<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width; initial-scale=1.0">
    <meta name="theme-color" content="#121212" />
    
    <title>Corus</title>
    
    <style type="text/css" media="all">
      
      :root {

      }
      
      * {
        box-sizing: border-box;
        margin : 0;
      }
      
      html {
        scroll-behavior: smooth;
      }
      
      body {
        font-family : sans-serif;
        font-weight : 500;
        background : #fff;
      }
    </style>
    
  </head>
  <body>
    <input type="text" id="messageInput" required>  
  <input type="number" id="typeInput" value="1" required>
  <button id='button' onclick="sendMessage()">Send</button> 
  <input type='checkbox' id="accept"> 

  <div class="notifs">

  </div>

  <script>
    const socket = new WebSocket('wss://corus-webserver.glitch.me');

    socket.onopen = (event) => {
        docwrite('Connection opened'); 
        //socket.send("my-room"); 
    }; 
    socket.onclose = (event) => {
        docwrite('Connection closed');
    }; 
    socket.onerror = (error) => {
        docwrite('WebSocket error: ' + error);
    }; 

    function timeGenerate(){
      const now = new Date();

      const oneMinuteFromNow = new Date(now.getTime() + 20 * 1000); 

      return {
        'hour' : oneMinuteFromNow.getHours(),
        'min' : oneMinuteFromNow.getMinutes(),
        'sec' : oneMinuteFromNow.getSeconds(),
        'ms' : oneMinuteFromNow.getMilliseconds(),
      }
    }

    function jsonify(msg,type){  
        var data = {
            type : type,
        }
        if ( type == 1 ) {
            data['src'] = msg; 
            data['playAt'] = timeGenerate()
        }else if ( type == 2){ 
            data['msg'] = msg;
        }
        return JSON.stringify(data);
    }

    const messageInput = document.getElementById('messageInput');
    const typeInput = document.getElementById('typeInput');
    const sendButton = document.getElementById('button');
    const acceptButton = document.getElementById('accept'); 

    sendButton.addEventListener('click', sendMessage);

    function sendMessage() {
      var message = messageInput.value; 
      var type = typeInput.value
      message = jsonify(message,type)
      socket.send(message);
      docwrite('Message sent: ' + message);
      messageInput.value = ''; 
    } 

    socket.onmessage = (event) => {  
        docwrite('Data received: ' + event.data); 
        var recvd = JSON.parse(event.data);  
        if (recvd.type == '1'){
          if (recvd.src != ''){  
            acceptButton.addEventListener('change', function(){
              if ( acceptButton.checked ){
                playSong(recvd.src,recvd.playAt) 
              }
            });
          } 
        }else if (recvd.type == '2'){
          docwrite(recvd.msg)
        }
    } 

    function playSong(src,playAt) {
      const audioElement = new Audio();
      audioElement.src = src; 

      audioElement.addEventListener("loadeddata", () => { 
        docwrite('loaded audio')
        const currentDate = new Date();
        const currentHour = currentDate.getHours();
        const currentMinute = currentDate.getMinutes();
        const currentSecond = currentDate.getSeconds(); 
        const currentMillisecond = currentDate.getMilliseconds();

        const targetMinute =  parseInt(playAt["min"]);
        const targetSecond = parseInt(playAt["sec"]); 
        const targetHour =  parseInt(playAt["hour"]);  
        const targetMillisecond = parseInt(playAt["ms"]); 

        docwrite('playing '+src+' at '+playAt["hour"]+':'+playAt["min"]+':'+playAt["sec"]+':'+playAt["ms"])

        const timeDiffMs = (targetHour * 60 + targetMinute) * 60 * 1000
                      + (targetSecond - currentSecond) * 1000
                      + (targetMillisecond - currentMillisecond)
                      - (currentHour * 60 + currentMinute) * 60 * 1000;

        setTimeout(() => {
          audioElement.play();
        }, timeDiffMs); 
      }); 
    }



  </script> 
  <script>
    let notifs = document.querySelector('.notifs') 
    function docwrite(notif){
      notifs.innerHTML += notif+'<br>'
    }
  </script>
  </body>
</html>
